---
title: ä½¿ç”¨ R åˆ†æå¯è§†åŒ–ä½ çš„ iPhone å¥åº· APP æ•°æ®
author: ZERO
date: '2019-04-24'
slug: analyze-and-visualize-your-iphone-s-health-app-data-in-r
categories:
  - datavis and dataclean
tags:
  - personal data
  - ggplot2
thumbnailImagePosition: left
thumbnailImage: https://i.loli.net/2019/04/24/5cc013b94ac97.jpg
metaAlignment: center
coverMeta: out
---

```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=TRUE, message=FALSE, warning=FALSE)
library(reticulate)
use_condaenv(condaenv = "tfdeeplearning", 
             conda = "/Users/zero/anaconda3/bin/conda")
#Enable the reticulate Python engine
#knitr::knit_engines(python = reticulate::eng_python)
```

## ä»‹ç»

iPhone çš„ health APP å­˜å‚¨ç€æˆ‘ä»¬çš„ç§äººå¥åº·æ•°æ®, è¿™é‡Œæœ‰ä¸€ç¯‡å¸–å­æ˜¯ç”¨ Python åˆ†æ health APP çš„æ•°æ®[Apple Health Data How to Export Analyze Visualize Guide - ryanpraski.com](http://www.ryanpraski.com/apple-health-data-how-to-export-analyze-visualize-guide/)
, è€Œæˆ‘æ›´å–œæ¬¢ R çš„ç‰ˆæœ¬. 

è®©æˆ‘ä»¬èµ¶ç´§å¼€å§‹å§!!

## é¦–å…ˆè·å–æ•°æ®å¹¶è¯»å–

1. ä»ä½ çš„ health APP åº”ç”¨ä¸­å¯¼å‡ºæ•°æ®
2. åœ¨ R ä¸­è¯»å–æ•°æ®

### åŠ è½½åŒ…å¹¶è¯»å…¥æ•°æ®
```{r}
library(XML)
library(tidyverse)
library(lubridate)
library(scales)
library(here)
library(ggthemes)
xml <- xmlParse(here("data/apple_health_export/export.xml"))
summary(xml)
```

Record æ˜¯æˆ‘çš„ä¸»è¦æ•°æ®, æœ‰ `r numform::f_comma(90037)` æ¡
```{r}
df_record <-   XML:::xmlAttrsToDataFrame(xml["//Record"])
```


Record æ•°æ®æŸ¥çœ‹
```{r}
library(kableExtra)
head(df_record) %>%
  kable("html") %>%
  kable_styling("hover", full_width = F)
```

## æ•°æ®æ¸…æ´—
æ³¨: æŸ¥çœ‹è‡ªåŠåœ¨å“ªä¸ªæ—¶åŒº "base::Sys.timezone()"
```{r}
 df <- df_record %>%
  mutate(device = gsub(".*(name:)|,.*", "",device),
         value = as.numeric(as.character(value)),
         endDate = ymd_hms(endDate,tz="Asia/Shanghai"),
         date = date(endDate),
         year = year(endDate),
         month = month(endDate),
         day = day(endDate),
         yday = yday(endDate),
         wday = wday(endDate),
         hour = hour(endDate),
         minute = minute(endDate),
         type = str_remove(type, "HKQuantityTypeIdentifier")
         )

```


## éƒ½æœ‰äº›ä»€ä¹ˆæ•°æ®å‘¢?
```{r}
df %>% select(type) %>% distinct()
```

## å…ˆçœ‹çœ‹ä½“é‡å˜åŒ–å§
```{r}
p_weight <- 
df %>%
  arrange(endDate) %>% 
  filter(type == 'BodyMass') %>% 
  # Had to reduce sourceName to these 2 sources to avoid double-counting
  # by other apps that use BodyMass and then store it back into Health
  #filter(sourceName %in% c("å¥åº·", "å°ç±³è¿åŠ¨")) %>% 
  
  ggplot(aes(x= date, y = value)) +
    geom_point(alpha = 0.3) +
    geom_smooth(span = 0.2, col = "grey30", se = FALSE) +
    theme_minimal()+ scale_color_tableau() + scale_fill_tableau() +
    labs(title = "Apple Health Weight Chart Sample",
         caption = "Zero Student") +
    theme(axis.text.x = element_text(angle = 0, hjust = 1), 
        legend.position = "bottom",
        plot.caption=element_text(size=12,family = "Arial",face = "bold",
                                  hjust=0, margin=margin(t=15)))
plotly::ggplotly(p_weight)
```
é¢, è¿™ä¸ªæ•°æ®ç‚¹å¥½åƒæœ‰ç‚¹å°‘, åœ¨ 18 å¹´ 10 æœˆä¹‹åå°±æ²¡ç”¨è¿‡å°ç±³ä½“é‡è®¡äº†


## çœ‹çœ‹æ­¥æ•°
```{r}
p_stepCount <- 
df %>%
  filter(type == 'StepCount') %>% 
  group_by(date,wday,hour) %>% 
  summarize(steps=sum(value)) %>% 
  group_by(hour,wday) %>% 
  summarize(steps=sum(steps)) %>% 
  arrange(desc(steps)) %>%
  ggplot(aes(x=hour, y=wday,  fill=steps)) + 
    geom_tile(col = 'grey40') + 
    scale_fill_continuous(labels = scales::comma, low = 'grey95', high = '#008FD5') +
    theme(panel.grid.major = element_blank()) +
    scale_x_continuous(
      breaks = c(0, 6, 12, 18),
      label = c("Midnight", "6 AM", "Midday", "6 PM")
    ) +
    scale_y_reverse(
      breaks = c(1,2,3,4,5,6,7),
      label = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")
    ) +
    theme_minimal()+ 
    theme(axis.text.x = element_text(angle = 0, hjust = 1), 
        legend.position = "bottom",
        plot.caption=element_text(size=12,family = "Arial",face = "bold",
                                  hjust=0, margin=margin(t=15))) +
    labs(title = "Weekly Step Count Heatmap",
         caption = 'Zero Student') +
    guides(fill=FALSE)+
    coord_equal()
plotly::ggplotly(p_stepCount)
```

ğŸ˜± ğŸ˜± ğŸ˜±  æƒŠå‘†äº†æˆ‘çš„å°ä¼™ä¼´, è¿™æ ·ä¸‹å»å¯æ€ä¹ˆåŠ?



## Links

- [Apple Health Data How to Export Analyze Visualize Guide - ryanpraski.com](http://www.ryanpraski.com/apple-health-data-how-to-export-analyze-visualize-guide/)

- [Analyze and visualize your iPhone's Health app data in R - Taras Kaduk](https://taraskaduk.com/2019/03/23/apple-health/)

